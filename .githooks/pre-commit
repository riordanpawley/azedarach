#!/bin/sh
# Pre-commit hook: Auto-fix and restage files

# Get list of staged .ts and .tsx files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -z "$STAGED_FILES" ]; then
  # No TypeScript files staged, skip
  exit 0
fi

echo "Running biome fix on staged files..."

# Run biome check with --write to auto-fix
bun run biome check --write --staged --no-errors-on-unmatched

BIOME_EXIT=$?

if [ $BIOME_EXIT -ne 0 ]; then
  echo ""
  echo "Biome found unfixable issues. Please resolve manually."
  echo ""
  exit 1
fi

# Re-stage any files that were modified by biome
for file in $STAGED_FILES; do
  # Skip deleted files - they don't need to be re-staged
  if [ -f "$file" ] && ! git diff --quiet "$file" 2>/dev/null; then
    echo "ğŸ“ $file was modified by biome. Re-staging..."
    git add "$file"
  fi
done

exit 0
